<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanic - Debug UI</title>
  <link rel="icon" type="image/x-icon" href="./public/favicon.ico">
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .panel {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .preview {
      flex: 1;
      min-width: 500px;
      position: relative;
      max-width: 800px;
    }
    .live-panel {
      flex: 1;
      min-width: 400px;
      position: relative;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      padding: 10px 20px;
      border-radius: 4px;
    }
    button:hover {
      background-color: #45a049;
    }
    canvas {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
    }
    #dropZone {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      margin-bottom: 15px;
      background-color: #f9f9f9;
    }
    #dropZone:hover {
      border-color: #999;
      background-color: #f0f0f0;
    }
    .sample-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .sample-image {
      width: 100%;
      height: 100px;
      object-fit: cover;
      cursor: pointer;
      border: 1px solid #ddd;
      transition: transform 0.2s;
      border-radius: 4px;
    }
    .sample-image:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .live-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .live-controls button {
      flex: 1;
      min-width: 120px;
    }
    .live-stats {
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      margin-top: 10px;
    }
    .live-video {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .status-active { background-color: #00ff00; }
    .status-inactive { background-color: #ff0000; }
    .status-detecting { background-color: #ffff00; }
    .capture-button {
      background-color: #ff4444 !important;
    }
    .capture-button:hover {
      background-color: #cc3333 !important;
    }
    .capture-button:disabled {
      background-color: #cccccc !important;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Scanic - Debug UI</h1>
  
  
  <div class="container">
    <div class="panel preview">
      <h3>Document Scanner Demo</h3>
      
      <div id="dropZone">
        <p>Drag & drop an image here<br>or click to select a file</p>
        <input type="file" id="fileInput" accept="image/*" style="display: none">
      </div>
      
      <h4>Sample Images</h4>
      <div class="sample-images" id="sampleImagesContainer">
        <!-- Will be populated with sample images -->
      </div>
      
      <div id="canvasContainerRewrite" style="position: relative; margin-top: 20px;">
        <canvas id="previewCanvasRewrite"></canvas>
      </div>
    </div>
    
    <!-- Live Scanner Panel -->
    <div class="panel live-panel">
      <h3>
        <span class="status-indicator" id="liveStatusIndicator"></span>
        Live Document Scanner
      </h3>
      
      <div class="live-controls">
        <button id="startLiveButton">Start Live</button>
        <button id="stopLiveButton" disabled>Stop</button>
        <button id="captureButton" class="capture-button" disabled>‚è≥ Detecting...</button>
      </div>
      
      <canvas id="liveCanvas" class="live-video"></canvas>
      
      <div class="live-stats" id="liveStats">
        <div>Status: <span id="liveStatus">Stopped</span></div>
        <div>Render FPS: <span id="liveFPS">0</span></div>
        <div>Detection FPS: <span id="liveDetectionFPS">0</span></div>
        <div>Resolution: <span id="liveResolution">-</span></div>
        <div>Document: <span id="liveDocumentStatus">Not detected</span></div>
      </div>
    </div>
  </div>
  
  <!-- Import our library from dist -->
  <script type="module">
    import * as scanic from './dist/scanic.js';
    
    // Make scanic available globally for the rest of the script
    window.scanic = scanic;
    
    console.log("Scanic ES6 module loaded successfully.");
    
    // Initialize after module is loaded
    window.initializeScanicDemo();
  </script>
  
  <!-- Import original jscanify -->
  <script src="./src/jscanify.js"></script>
  
  <script>
    // Global flag and scanner instances
    let cvReady = false;
    let rewriteApi = null; // Will be populated by the module script
    let liveScanner = null; // Live scanner instance
    let currentImage = null;

    // Initialize Scanic demo after module loads
    window.initializeScanicDemo = function() {
      rewriteApi = window.scanic;
      console.log("Scanic library initialized successfully.");
      
      // Check webcam support after API is loaded
      setTimeout(checkWebcamSupport, 100);
    };

  
    // --- DOM elements ---
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const previewCanvasRewrite = document.getElementById('previewCanvasRewrite');
    const canvasContainerRewrite = document.getElementById('canvasContainerRewrite');
    const sampleImagesContainer = document.getElementById('sampleImagesContainer');
    
    // Live scanner elements
    const startLiveButton = document.getElementById('startLiveButton');
    const stopLiveButton = document.getElementById('stopLiveButton');
    const captureButton = document.getElementById('captureButton');
    const liveCanvas = document.getElementById('liveCanvas');
    const liveStatusIndicator = document.getElementById('liveStatusIndicator');
    const liveStatus = document.getElementById('liveStatus');
    const liveFPS = document.getElementById('liveFPS');
    const liveDetectionFPS = document.getElementById('liveDetectionFPS');
    const liveResolution = document.getElementById('liveResolution');
    const liveDocumentStatus = document.getElementById('liveDocumentStatus');

    // --- Live Scanner Functions ---
    async function initLiveScanner() {
      if (!rewriteApi || !rewriteApi.LiveScanner) {
        alert('Live scanner not available. Please ensure the module is loaded.');
        return;
      }
      
      try {
        // Create live scanner instance
        liveScanner = new rewriteApi.LiveScanner({
          targetFPS: 15,
          detectionInterval: 100, // Check every 200ms
          stabilizationFrames: 3,
          maxProcessingDimension: 500,
          lowThreshold: 50,
          highThreshold: 150,
          minArea: 1000,
          epsilon: 0.02,
          dilationKernelSize: 5
        });
        
        // Set up callbacks
        liveScanner.onDetection = (result) => {
          if (result.isStable) {
            liveDocumentStatus.textContent = `üìÑ Document Ready (confidence: ${(result.confidence * 100).toFixed(1)}%)`;
            liveStatusIndicator.className = 'status-indicator status-detecting';
            captureButton.disabled = false;
            captureButton.textContent = 'üì∏ Capture & Extract';
          } else {
            liveDocumentStatus.textContent = 'üîç Stabilizing...';
            liveStatusIndicator.className = 'status-indicator status-active';
            captureButton.disabled = true;
            captureButton.textContent = '‚è≥ Detecting...';
          }
        };
        
        liveScanner.onFPSUpdate = (stats) => {
          liveFPS.textContent = stats.renderFPS;
          liveDetectionFPS.textContent = stats.detectionFPS;
        };
        
        liveScanner.onError = (error) => {
          console.error('Live scanner error:', error);
          updateLiveStatus('Error: ' + error.message, 'inactive');
        };
        
        // Initialize with canvas
        await liveScanner.init(liveCanvas);
        
        updateLiveStatus('Ready', 'active');
        startLiveButton.disabled = false;
        
        const stats = liveScanner.getStats();
        liveResolution.textContent = stats.videoResolution || 'Unknown';
        
      } catch (error) {
        console.error('Failed to initialize live scanner:', error);
        updateLiveStatus('Initialization failed: ' + error.message, 'inactive');
      }
    }
    
    function startLiveScanning() {
      if (!liveScanner) {
        initLiveScanner();
        return;
      }
      
      try {
        liveScanner.start();
        updateLiveStatus('Scanning', 'active');
        startLiveButton.disabled = true;
        stopLiveButton.disabled = false;
      } catch (error) {
        console.error('Failed to start live scanning:', error);
        updateLiveStatus('Failed to start: ' + error.message, 'inactive');
      }
    }
    
    function stopLiveScanning() {
      if (liveScanner) {
        liveScanner.stop();
        liveScanner = null;
      }
      
      updateLiveStatus('Stopped', 'inactive');
      startLiveButton.disabled = false;
      stopLiveButton.disabled = true;
      captureButton.disabled = true;
      captureButton.textContent = '‚è≥ Detecting...';
      liveDocumentStatus.textContent = 'Not detected';
      liveFPS.textContent = '0';
      liveDetectionFPS.textContent = '0';
      liveResolution.textContent = '-';
    }
    
    async function captureDocument() {
      if (!liveScanner) {
        alert('Live scanner not running');
        return;
      }
      
      try {
        captureButton.disabled = true;
        captureButton.textContent = 'Capturing...';
        
        // Capture the original frame first for comparison
        const originalCanvas = document.createElement('canvas');
        originalCanvas.width = liveScanner.video.videoWidth;
        originalCanvas.height = liveScanner.video.videoHeight;
        const originalCtx = originalCanvas.getContext('2d');
        originalCtx.drawImage(liveScanner.video, 0, 0);
        
        // Add overlay to show detected corners on original
        if (liveScanner.currentCorners) {
          liveScanner.drawDocumentOverlay(liveScanner.currentCorners, originalCtx, 
            liveScanner.video.videoWidth / liveScanner.outputCanvas.width,
            liveScanner.video.videoHeight / liveScanner.outputCanvas.height);
        }
        
        // Capture the perspective-corrected document
        const transformedCanvas = await liveScanner.captureDocument();
        
        // Show both original and transformed in a new window
        const newWindow = window.open('', '_blank', 'width=1200,height=700');
        const originalDataURL = originalCanvas.toDataURL();
        const transformedDataURL = transformedCanvas.toDataURL();
        
        const htmlContent = `
          <html>
            <head>
              <title>Captured Document - Scanic</title>
              <style>
                body { 
                  margin: 0; 
                  padding: 20px; 
                  background: #f0f0f0; 
                  font-family: system-ui, -apple-system, sans-serif;
                }
                .container {
                  display: flex;
                  gap: 20px;
                  justify-content: center;
                  flex-wrap: wrap;
                }
                .panel {
                  background: white;
                  padding: 15px;
                  border-radius: 8px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  text-align: center;
                  max-width: 500px;
                }
                canvas {
                  max-width: 100%;
                  height: auto;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                }
                h2 { 
                  margin-top: 0; 
                  color: #333;
                }
                h3 {
                  color: #666;
                  margin-bottom: 10px;
                }
                .controls {
                  margin-top: 20px;
                  text-align: center;
                }
                button {
                  background: #4CAF50;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  margin: 0 5px;
                  border-radius: 4px;
                  cursor: pointer;
                  font-weight: bold;
                }
                button:hover {
                  background: #45a049;
                }
                .highlight {
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                }
                .highlight:hover {
                  background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
                }
              </style>
            </head>
            <body>
              <h2>üìÑ Document Capture Results</h2>
              <div class="container">
                <div class="panel">
                  <h3>üéØ Original with Detection</h3>
                  <canvas id="originalCanvas"></canvas>
                  <p><small>Shows the original frame with detected document outline</small></p>
                </div>
                <div class="panel">
                  <h3>‚ú® Perspective Corrected</h3>
                  <canvas id="transformedCanvas"></canvas>
                  <p><small>Document extracted and perspective-corrected for scanning</small></p>
                </div>
              </div>
              <div class="controls">
                <button onclick="downloadCanvas('transformedCanvas', 'scanned-document')" class="highlight">
                  üì• Download Scanned Document
                </button>
                <button onclick="downloadCanvas('originalCanvas', 'original-with-detection')">
                  üì• Download Original
                </button>
                <button onclick="window.close()">‚ùå Close</button>
              </div>
              
              <script>
                const originalCanvas = document.getElementById('originalCanvas');
                const transformedCanvas = document.getElementById('transformedCanvas');
                
                // Load original image
                const originalCtx = originalCanvas.getContext('2d');
                originalCanvas.width = ${originalCanvas.width};
                originalCanvas.height = ${originalCanvas.height};
                const originalImg = new Image();
                originalImg.onload = function() {
                  originalCtx.drawImage(originalImg, 0, 0);
                };
                originalImg.src = '${originalDataURL}';
                
                // Load transformed image
                const transformedCtx = transformedCanvas.getContext('2d');
                transformedCanvas.width = ${transformedCanvas.width};
                transformedCanvas.height = ${transformedCanvas.height};
                const transformedImg = new Image();
                transformedImg.onload = function() {
                  transformedCtx.drawImage(transformedImg, 0, 0);
                };
                transformedImg.src = '${transformedDataURL}';
                
                function downloadCanvas(canvasId, filename) {
                  const canvas = document.getElementById(canvasId);
                  const link = document.createElement('a');
                  link.download = filename + '-' + new Date().toISOString().slice(0,19).replace(/:/g, '-') + '.png';
                  link.href = canvas.toDataURL('image/png', 1.0);
                  link.click();
                }
              <\/script>
            </body>
          </html>
        `;
        newWindow.document.write(htmlContent);
        
      } catch (error) {
        console.error('Failed to capture document:', error);
        alert('Failed to capture document: ' + error.message);
      } finally {
        captureButton.disabled = false;
        captureButton.textContent = 'üì∏ Capture & Extract';
      }
    }
    
    function updateLiveStatus(status, indicatorClass) {
      liveStatus.textContent = status;
      liveStatusIndicator.className = `status-indicator status-${indicatorClass}`;
    }
    
    // Check webcam availability on load
    async function checkWebcamSupport() {
      if (!rewriteApi || !rewriteApi.checkWebcamAvailability) {
        console.log('Webcam check not available yet');
        return;
      }
      
      const result = await rewriteApi.checkWebcamAvailability();
      if (!result.available) {
        updateLiveStatus('No webcam available', 'inactive');
        startLiveButton.disabled = true;
        console.warn('Webcam not available:', result.error);
      } else {
        console.log(`Webcam available: ${result.deviceCount} device(s) found`);
        updateLiveStatus('Webcam ready', 'inactive');
      }
    }

    // --- Functions ---
    function loadSampleImage() {
      // Load first test image automatically
      loadImageFromSrc('./testImages/test.png');
    }

    function loadSampleImages() {
      const testImagePaths = [
        './testImages/test.png',
        './testImages/test2.png',
        './testImages/test3.jpg',
        './testImages/test4.JPG',
        './testImages/test5.JPG',
        './testImages/test6.JPG',
        './testImages/test7.JPG',
        './testImages/test8.JPG',
        './testImages/test9.jpg',
        './testImages/test10.jpg',
      ];
      sampleImagesContainer.innerHTML = '';
      testImagePaths.forEach((path, index) => {
        const img = document.createElement('img');
        img.src = path;
        img.classList.add('sample-image');
        img.alt = `Sample image ${index + 1}`;
        img.title = `Sample image ${index + 1}`;
        img.addEventListener('click', () => {
          loadImageFromSrc(path);
        });
        sampleImagesContainer.appendChild(img);
      });
    }

    function handleFileSelect(file) {
      if (!file || !file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        loadImageFromSrc(e.target.result);
      };
      reader.readAsDataURL(file);
    }
    
    function loadImageFromSrc(src) {
        const img = new Image();
        img.onload = function() {
          currentImage = img;
          // Ensure OpenCV is ready before drawing/processing
          if (cvReady) {
             resizeCanvas();
             drawImage();
             processImage();
          } else {
             // Draw placeholder or wait message if OpenCV isn't ready
             console.log("Waiting for OpenCV to load...");
             const ctxRewrite = previewCanvasRewrite.getContext('2d');
             ctxRewrite.clearRect(0, 0, previewCanvasRewrite.width, previewCanvasRewrite.height);
             ctxRewrite.fillText("Loading OpenCV...", 10, 20);
          }
        };
        img.onerror = () => alert("Failed to load image");
        img.src = src;
    }

    function drawImage() {
      if (!currentImage || !cvReady) return;
      // Draw on preview canvas
      const ctxRewrite = previewCanvasRewrite.getContext('2d');
      ctxRewrite.clearRect(0, 0, previewCanvasRewrite.width, previewCanvasRewrite.height);
      ctxRewrite.drawImage(currentImage, 0, 0, previewCanvasRewrite.width, previewCanvasRewrite.height);
    }

    function resizeCanvas() {
      if (!currentImage) return;
      const maxWidth = canvasContainerRewrite.clientWidth;
      const scale = Math.min(1, maxWidth / currentImage.width);
      const scaledWidth = currentImage.width * scale;
      const scaledHeight = currentImage.height * scale;

      previewCanvasRewrite.width = scaledWidth;
      previewCanvasRewrite.height = scaledHeight;
    }

    async function processImage() {
      if (!currentImage) {
        return;
      }
      if (!cvReady) {
        console.log('OpenCV is not ready yet. Please wait.');
        return;
      }
      if (!rewriteApi) {
        console.log('Scanic library module not loaded yet.');
        return;
      }

      const options = {
        lowThreshold: 50,
        highThreshold: 150,
        minArea: 1000,
        epsilon: 0.02,
        dilationKernelSize: 5,
        debug: false,
        mode: 'detect', // Use detect mode to get corners only
        output: 'canvas',
      };

      // --- Process with Scanic unified API ---
      try {
        const result = await rewriteApi.scanDocument(currentImage, options);
        
        // Clear and redraw the original image
        const ctx = previewCanvasRewrite.getContext('2d');
        ctx.clearRect(0, 0, previewCanvasRewrite.width, previewCanvasRewrite.height);
        ctx.drawImage(currentImage, 0, 0, previewCanvasRewrite.width, previewCanvasRewrite.height);
        
        // If document detected, draw the sleek border overlay
        if (result.success && result.corners) {
          drawDocumentOverlay(result.corners, ctx);
        }
        
      } catch (error) {
        console.error('Error processing rewrite:', error);
      }
    }

    // Function to draw the sleek document border overlay
    function drawDocumentOverlay(corners, ctx) {
      const canvas = ctx.canvas;
      const scaleX = canvas.width / currentImage.width;
      const scaleY = canvas.height / currentImage.height;
      
      // Scale corners to canvas coordinates
      const scaledCorners = {
        topLeft: [corners.topLeft.x * scaleX, corners.topLeft.y * scaleY],
        topRight: [corners.topRight.x * scaleX, corners.topRight.y * scaleY],
        bottomRight: [corners.bottomRight.x * scaleX, corners.bottomRight.y * scaleY],
        bottomLeft: [corners.bottomLeft.x * scaleX, corners.bottomLeft.y * scaleY]
      };
      
      // Save context
      ctx.save();
      
      // Draw sleek border
      ctx.strokeStyle = '#00ff00';
      ctx.lineWidth = 3;
      ctx.shadowColor = 'rgba(0, 255, 0, 0.5)';
      ctx.shadowBlur = 10;
      
      // Draw the document outline
      ctx.beginPath();
      ctx.moveTo(scaledCorners.topLeft[0], scaledCorners.topLeft[1]);
      ctx.lineTo(scaledCorners.topRight[0], scaledCorners.topRight[1]);
      ctx.lineTo(scaledCorners.bottomRight[0], scaledCorners.bottomRight[1]);
      ctx.lineTo(scaledCorners.bottomLeft[0], scaledCorners.bottomLeft[1]);
      ctx.closePath();
      ctx.stroke();
      
      // Draw corner markers
      const cornerRadius = 8;
      ctx.fillStyle = '#00ff00';
      ctx.shadowBlur = 5;
      
      Object.values(scaledCorners).forEach(([x, y]) => {
        ctx.beginPath();
        ctx.arc(x, y, cornerRadius, 0, 2 * Math.PI);
        ctx.fill();
      });
      
      // Add semi-transparent fill
      ctx.fillStyle = 'rgba(0, 255, 0, 0.1)';
      ctx.shadowBlur = 0;
      ctx.beginPath();
      ctx.moveTo(scaledCorners.topLeft[0], scaledCorners.topLeft[1]);
      ctx.lineTo(scaledCorners.topRight[0], scaledCorners.topRight[1]);
      ctx.lineTo(scaledCorners.bottomRight[0], scaledCorners.bottomRight[1]);
      ctx.lineTo(scaledCorners.bottomLeft[0], scaledCorners.bottomLeft[1]);
      ctx.closePath();
      ctx.fill();
      
      // Restore context
      ctx.restore();
    }

    // --- Event Listeners ---
    fileInput.addEventListener('change', function() { handleFileSelect(this.files[0]); });
    dropZone.addEventListener('click', function() { fileInput.click(); });
    dropZone.addEventListener('dragover', function(e) { 
      e.preventDefault(); 
      e.stopPropagation(); 
      this.style.backgroundColor = '#e9e9e9'; 
    });
    dropZone.addEventListener('dragleave', function(e) { 
      e.preventDefault(); 
      e.stopPropagation(); 
      this.style.backgroundColor = '#f9f9f9'; 
    });
    dropZone.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      this.style.backgroundColor = '#f9f9f9';
      handleFileSelect(e.dataTransfer.files[0]);
    });
    
    // Live scanner event listeners
    startLiveButton.addEventListener('click', startLiveScanning);
    stopLiveButton.addEventListener('click', stopLiveScanning);
    captureButton.addEventListener('click', captureDocument);
    window.addEventListener('resize', function() { resizeCanvas(); drawImage(); });

    // --- Initialization ---
    loadSampleImages();
    updateLiveStatus('Initializing...', 'inactive');
    console.log('Demo UI Initialized. Waiting for OpenCV...');

  </script>
</body>
</html>